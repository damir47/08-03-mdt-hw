---
- name: "Install and configure Elasticsearch"
  hosts: elastic
  become: yes
  gather_facts: yes
  vars_files:
    - vault/vault.yml
    - vars/elastic.yml

  tasks:
    - name: "Install dependencies"
      apt:
        name:
          - wget
          - curl
          - gnupg
          - apt-transport-https
          - openjdk-17-jre-headless
        state: present
        update_cache: yes

    - name: "Set Java environment"
      lineinfile:
        path: /etc/environment
        line: "JAVA_HOME=/usr/lib/jvm/java-17-openjdk-amd64"
        create: yes

    - name: "Add Elasticsearch repository (Yandex mirror)"
      apt_repository:
        repo: "deb [trusted=yes] https://mirror.yandex.ru/mirrors/elastic/8/ stable main"
        state: present
        filename: elasticsearch
        update_cache: yes

    - name: "Install Elasticsearch"
      apt:
        name: elasticsearch
        state: present

    - name: "Stop Elasticsearch if running"
      systemd:
        name: elasticsearch
        state: stopped
      ignore_errors: yes

    - name: "Increase vm.max_map_count"
      sysctl:
        name: vm.max_map_count
        value: '262144'
        state: present
        reload: yes

    - name: "Configure Elasticsearch (SSL disabled)"
      copy:
        dest: /etc/elasticsearch/elasticsearch.yml
        content: |
          cluster.name: zabbix-cluster
          node.name: elk01
          path.data: /var/lib/elasticsearch
          path.logs: /var/log/elasticsearch
          network.host: 0.0.0.0
          http.port: 9200
          discovery.type: single-node
          
          # DISABLE ALL SECURITY FOR TEST ENVIRONMENT
          xpack.security.enabled: false
          xpack.security.transport.ssl.enabled: false
          xpack.security.http.ssl.enabled: false
        owner: root
        group: elasticsearch
        mode: '0640'

    - name: "Configure JVM heap (minimal for small server)"
      copy:
        dest: /etc/elasticsearch/jvm.options.d/heap.options
        content: |
          -Xms1g
          -Xmx1g
        owner: root
        group: elasticsearch
        mode: '0644'

    - name: "Fix all permissions"
      file:
        path: "{{ item.path }}"
        state: directory
        owner: elasticsearch
        group: elasticsearch
        mode: '{{ item.mode }}'
        recurse: yes
      loop:
        - { path: /var/lib/elasticsearch, mode: '0755' }
        - { path: /var/log/elasticsearch, mode: '0755' }
        - { path: /etc/elasticsearch, mode: '0750' }

    - name: "Reload systemd"
      systemd:
        daemon_reload: yes

    - name: "Start Elasticsearch"
      systemd:
        name: elasticsearch
        state: started
        enabled: yes

    - name: "Wait for Elasticsearch to be ready"
      wait_for:
        port: 9200
        host: "{{ ansible_default_ipv4.address }}"
        delay: 15
        timeout: 120
      register: wait_result

    - name: "Verify Elasticsearch is running"
      uri:
        url: "http://localhost:9200"
        method: GET
      register: es_status
      when: wait_result is success

    - name: "Final status"
      debug:
        msg: |
          ========================================
             Elasticsearch is running
          ========================================
          Version: {{ es_status.json.version.number }}
          Cluster: {{ es_status.json.cluster_name }}
          
           Internal access:
               http://vm-yc-elk01.ru-central1.internal:9200
          ========================================
      when: wait_result is success