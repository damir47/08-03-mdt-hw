---
- name: "Install Zabbix Agents"
  hosts: all:!bastion
  become: yes
  gather_facts: yes
  serial: 5
  vars_files:
    - vault/vault.yml

  tasks:
    - name: "Add Zabbix 7.0 repository"
      apt:
        deb: "https://repo.zabbix.com/zabbix/7.0/ubuntu/pool/main/z/zabbix-release/zabbix-release_7.0-1+ubuntu24.04_all.deb"
        state: present

    - name: "Update apt cache"
      apt:
        update_cache: yes

    - name: "Install Zabbix Agent"
      apt:
        name: zabbix-agent
        state: present

    - name: "Create systemd override directory"
      file:
        path: /etc/systemd/system/zabbix-agent.service.d
        state: directory
        mode: '0755'

    - name: "Deploy systemd override (решает проблему PID)"
      copy:
        dest: /etc/systemd/system/zabbix-agent.service.d/override.conf
        content: |
          [Service]
          RuntimeDirectory=zabbix
          RuntimeDirectoryMode=0755
          PIDFile=/run/zabbix/zabbix_agentd.pid
          ExecStartPre=/bin/mkdir -p /run/zabbix
          ExecStartPre=/bin/chown zabbix:zabbix /run/zabbix
          Restart=always
          RestartSec=10s
        mode: '0644'

    - name: "Reload systemd"
      systemd:
        daemon_reload: yes

    - name: "Ensure log directory exists"
      file:
        path: /var/log/zabbix
        state: directory
        owner: zabbix
        group: zabbix
        mode: '0755'

    - name: "Get Zabbix server hostname"
      set_fact:
        zabbix_server_fqdn: "vm-yc-zbx01.ru-central1.internal"

    - name: "Configure Zabbix Agent (template)"
      template:
        src: zabbix_agentd.conf.j2
        dest: /etc/zabbix/zabbix_agentd.conf
        owner: root
        group: zabbix
        mode: '0640'
      notify: restart zabbix-agent

    - name: "Remove deprecated option"
      lineinfile:
        path: /etc/zabbix/zabbix_agentd.conf
        regexp: "^EnableRemoteCommands"
        state: absent
      notify: restart zabbix-agent

    - name: "Ensure Server points to localhost on Zabbix server"
      lineinfile:
        path: /etc/zabbix/zabbix_agentd.conf
        regexp: "^Server="
        line: "Server=127.0.0.1"
      when: inventory_hostname == "zabbix"
      notify: restart zabbix-agent

    - name: "Ensure ServerActive points to localhost on Zabbix server"
      lineinfile:
        path: /etc/zabbix/zabbix_agentd.conf
        regexp: "^ServerActive="
        line: "ServerActive=127.0.0.1"
      when: inventory_hostname == "zabbix"
      notify: restart zabbix-agent

    - name: "Stop agent if running"
      systemd:
        name: zabbix-agent
        state: stopped
      ignore_errors: yes

    - name: "Remove stale PID file"
      file:
        path: /run/zabbix/zabbix_agentd.pid
        state: absent
      ignore_errors: yes

    - name: "Start Zabbix Agent"
      systemd:
        name: zabbix-agent
        state: started
        enabled: yes
      register: start_result
      retries: 3
      delay: 5
      until: start_result is success

    - name: "Wait for PID file to appear"
      wait_for:
        path: /run/zabbix/zabbix_agentd.pid
        timeout: 45
      register: pid_check
      ignore_errors: yes

    - name: "Debug PID file location"
      shell: |
        ls -la /run/zabbix/ || echo "No /run/zabbix"
        ps aux | grep zabbix_agentd || echo "No process"
      register: debug_info
      when: pid_check is failed

    - name: "Show debug info"
      debug:
        var: debug_info.stdout_lines
      when: pid_check is failed

    - name: "Wait for agent to be ready (port)"
      wait_for:
        port: 10050
        host: "{{ ansible_default_ipv4.address }}"
        delay: 5
        timeout: 45

    - name: "Agent is ready"
      debug:
        msg: "{{ inventory_hostname }}: Zabbix agent is running"

  handlers:
    - name: restart zabbix-agent
      systemd:
        name: zabbix-agent
        state: restarted
        daemon_reload: yes
      ignore_errors: yes
      listen: "restart zabbix-agent"