- name: "Install Zabbix Agents"
  hosts: all:!bastion
  become: yes
  gather_facts: yes
  serial: 5
  vars_files:
    - vault/vault.yml

  tasks:
    - name: "Add Zabbix repository"
      apt:
        deb: "https://repo.zabbix.com/zabbix/7.0/ubuntu/pool/main/z/zabbix-release/zabbix-release_7.0-1+ubuntu24.04_all.deb"
        state: present

    - name: "Update apt cache"
      apt:
        update_cache: yes

    - name: "Install Zabbix Agent"
      apt:
        name: zabbix-agent
        state: present

    - name: "Create necessary directories"
      file:
        path: "{{ item }}"
        state: directory
        owner: zabbix
        group: zabbix
        mode: '0755'
      loop:
        - /var/log/zabbix
        - /run/zabbix

    - name: "Get hostname for config"
      set_fact:
        agent_hostname: "{{ ansible_hostname | default(inventory_hostname) }}"

    - name: "Configure Zabbix Agent"
      template:
        src: zabbix_agentd.conf.j2
        dest: /etc/zabbix/zabbix_agentd.conf
        owner: root
        group: zabbix
        mode: '0640'
      notify: restart zabbix-agent

    - name: "Remove deprecated option"
      lineinfile:
        path: /etc/zabbix/zabbix_agentd.conf
        regexp: "^EnableRemoteCommands"
        state: absent
      notify: restart zabbix-agent

    - name: "Reload systemd"
      systemd:
        daemon_reload: yes

    - name: "Start Zabbix Agent"
      systemd:
        name: zabbix-agent
        state: started
        enabled: yes
      register: start_result
      retries: 3
      delay: 5
      until: start_result is success

    - name: "Wait for agent to be ready"
      wait_for:
        port: 10050
        host: "{{ ansible_default_ipv4.address }}"
        delay: 5
        timeout: 30

    - name: "Agent is ready (port 10050 open)"
      debug:
        msg: "{{ inventory_hostname }}: Zabbix agent is running (port 10050 open)"