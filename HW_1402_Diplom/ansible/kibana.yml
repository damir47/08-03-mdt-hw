---
- name: "Install and configure Kibana"
  hosts: kibana
  become: yes
  gather_facts: yes
  vars_files:
    - vault/vault.yml
    - vars/elastic.yml

  tasks:
    - name: "Install dependencies"
      apt:
        name:
          - wget
          - curl
          - gnupg
          - apt-transport-https
        state: present
        update_cache: yes

    - name: "Remove ALL Elastic/Kibana repositories"
      file:
        path: "{{ item }}"
        state: absent
      loop:
        - /etc/apt/sources.list.d/elasticsearch.list
        - /etc/apt/sources.list.d/elasticsearch.list.save
        - /etc/apt/sources.list.d/kibana.list
        - /etc/apt/sources.list.d/kibana.list.save
        - /etc/apt/sources.list.d/elastic-8.x.list
        - /etc/apt/sources.list.d/elastic-8.x.list.save
      ignore_errors: yes

    - name: "Add Kibana repository (Yandex mirror)"
      copy:
        dest: /etc/apt/sources.list.d/elastic-8.x.list
        content: |
          deb [trusted=yes] https://mirror.yandex.ru/mirrors/elastic/8/ stable main
        mode: '0644'

    - name: "Update apt cache"
      apt:
        update_cache: yes

    - name: "Install Kibana"
      apt:
        name: kibana
        state: present

    - name: "Configure Kibana"
      copy:
        dest: /etc/kibana/kibana.yml
        content: |
          # Kibana configuration
          server.port: 5601
          server.host: "0.0.0.0"
          elasticsearch.hosts: ["http://vm-yc-elk01.ru-central1.internal:9200"]
          elasticsearch.requestTimeout: 60000
          elasticsearch.pingTimeout: 30000
          pid.file: /run/kibana/kibana.pid
          logging:
            appenders:
              file:
                type: file
                fileName: /var/log/kibana/kibana.log
                layout:
                  type: json
            root:
              appenders: [default, file]
        owner: root
        group: kibana
        mode: '0640'

    - name: "Create Kibana log directory"
      file:
        path: /var/log/kibana
        state: directory
        owner: kibana
        group: kibana
        mode: '0755'

    - name: "Wait for Elasticsearch to be fully ready"
      uri:
        url: "http://vm-yc-elk01.ru-central1.internal:9200/_cluster/health"
        method: GET
      register: es_health
      retries: 30
      delay: 10
      until:
        - es_health.status == 200
        - es_health.json.status in ['green', 'yellow']
      changed_when: false

    - name: "Start and enable Kibana"
      systemd:
        name: kibana
        state: started
        enabled: yes

    - name: "Wait for Kibana to initialize"
      wait_for:
        port: 5601
        host: "{{ ansible_default_ipv4.address }}"
        delay: 15
        timeout: 300
      register: wait_result
      ignore_errors: yes

    - name: "Check Kibana API status"
      uri:
        url: "http://localhost:5601/api/status"
        method: GET
      register: kibana_api
      retries: 12
      delay: 10
      until:
        - kibana_api.status == 200
        - kibana_api.json.status.overall.level == 'available'
      when: wait_result is success

    - name: "Show Kibana access info"
      debug:
        msg: |
          ========================================
           Kibana is running
          ========================================
          Internal URL: http://{{ ansible_default_ipv4.address }}:5601
          External URL: http://{{ hostvars['kibana']['ansible_default_ipv4']['address'] }}:5601
          ========================================
      when: kibana_api is defined and kibana_api.status == 200

    - name: "Show Kibana logs on failure"
      shell: |
        echo "=== Journal logs ==="
        journalctl -u kibana -n 50 --no-pager
        echo "=== Kibana log file ==="
        tail -50 /var/log/kibana/kibana.log 2>/dev/null || echo "Log file not found"
      register: kibana_logs
      when: kibana_api is not defined or kibana_api.status != 200

    - name: "Display logs"
      debug:
        var: kibana_logs.stdout_lines
      when: kibana_logs is defined

  handlers:
    - name: restart kibana
      systemd:
        name: kibana
        state: restarted