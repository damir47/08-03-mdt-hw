---
- name: "Install and configure Filebeat for nginx logs"
  hosts: web01,web02
  become: yes
  gather_facts: yes
  vars_files:
    - vault/vault.yml
    - vars/elastic.yml

  tasks:
    - name: "Install dependencies"
      apt:
        name:
          - wget
          - curl
          - gnupg
          - apt-transport-https
        state: present
        update_cache: yes

    - name: "Remove ALL Elastic/Filebeat repositories"
      file:
        path: "{{ item }}"
        state: absent
      loop:
        - /etc/apt/sources.list.d/elasticsearch.list
        - /etc/apt/sources.list.d/elasticsearch.list.save
        - /etc/apt/sources.list.d/beats.list
        - /etc/apt/sources.list.d/beats.list.save
        - /etc/apt/sources.list.d/elastic-8.x.list
        - /etc/apt/sources.list.d/elastic-8.x.list.save
      ignore_errors: yes

    - name: "Add Filebeat repository (Yandex mirror)"
      copy:
        dest: /etc/apt/sources.list.d/elastic-8.x.list
        content: |
          deb [trusted=yes] https://mirror.yandex.ru/mirrors/elastic/8/ stable main
        mode: '0644'

    - name: "Update apt cache"
      apt:
        update_cache: yes
        cache_valid_time: 0

    - name: "Install Filebeat"
      apt:
        name: filebeat
        state: present
      register: install_result
      retries: 3
      delay: 5
      until: install_result is success

    - name: "Set Elasticsearch IP"
      set_fact:
        elastic_ip: "10.0.3.20"
        kibana_hostname: "vm-yc-kib01.ru-central1.internal"

    - name: "Configure Filebeat"
      template:
        src: filebeat.yml.j2
        dest: /etc/filebeat/filebeat.yml
        owner: root
        group: root
        mode: '0644'
      notify: restart filebeat

    - name: "Enable nginx module"
      command: filebeat modules enable nginx
      changed_when: false

    - name: "Configure nginx module"
      template:
        src: filebeat-nginx.yml.j2
        dest: /etc/filebeat/modules.d/nginx.yml
        owner: root
        group: root
        mode: '0644'
      notify: restart filebeat

    - name: "Ensure nginx logs are readable"
      file:
        path: /var/log/nginx
        state: directory
        mode: '0755'
        recurse: yes

    - name: "Load Filebeat index template"
      command: |
        filebeat setup --index-management \
          -E output.elasticsearch.hosts=["{{ elastic_ip }}:9200"]
      changed_when: false

    - name: "Start and enable Filebeat"
      systemd:
        name: filebeat
        state: started
        enabled: yes

    - name: "Wait for Filebeat to start"
      wait_for:
        port: 9200
        host: "{{ elastic_ip }}"
        delay: 5
        timeout: 60
      delegate_to: localhost

    - name: "Check Filebeat connection to Elasticsearch"
      command: filebeat test output
      register: filebeat_test
      changed_when: false

    - name: "Show connection status"
      debug:
        msg: |
          Filebeat on {{ inventory_hostname }}
          Sending logs to Elasticsearch: {{ elastic_ip }}:9200
          Kibana setup host: http://{{ kibana_hostname }}:5601
          Connection test: {{ 'OK' if 'elasticsearch' in filebeat_test.stdout else 'FAILED' }}

  handlers:
    - name: restart filebeat
      systemd:
        name: filebeat
        state: restarted