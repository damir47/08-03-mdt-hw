---
- name: "Zabbix Server Core"
  hosts: zabbix
  become: yes
  gather_facts: yes
  vars_files:
    - vault/vault.yml

  tasks:
    - name: "Install dependencies"
      apt:
        name:
          - wget
          - gnupg
          - software-properties-common
        state: present
        update_cache: yes

    - name: "Add Zabbix 7.0 repository"
      apt:
        deb: "https://repo.zabbix.com/zabbix/7.0/ubuntu/pool/main/z/zabbix-release/zabbix-release_7.0-1+ubuntu24.04_all.deb"
        state: present

    - name: "Update apt cache"
      apt:
        update_cache: yes

    - name: "Install Zabbix core packages"
      apt:
        name:
          - zabbix-server-pgsql
          - zabbix-sql-scripts
          - zabbix-agent
          - postgresql-client-16
        state: present

    - name: "Wait for PostgreSQL"
      wait_for:
        port: 5432
        host: "{{ ansible_default_ipv4.address }}"
        delay: 5
        timeout: 30

    - name: "Create Zabbix database and user"
      become_user: postgres
      become: yes
      shell: |
        psql -c "CREATE USER zabbix WITH PASSWORD '{{ vault_zabbix_db_password }}';" 2>/dev/null || true
        psql -c "CREATE DATABASE zabbix OWNER zabbix ENCODING 'UTF8';" 2>/dev/null || true
      no_log: true

    - name: "Import Zabbix schema"
      become_user: postgres
      become: yes
      shell: |
        export PGPASSWORD='{{ vault_zabbix_db_password }}'
        zcat /usr/share/zabbix-sql-scripts/postgresql/server.sql.gz | psql -U zabbix -d zabbix
      register: schema_import
      changed_when: "'CREATE' in schema_import.stdout or 'ALTER' in schema_import.stdout"
      no_log: true

    - name: "Configure Zabbix server"
      lineinfile:
        path: /etc/zabbix/zabbix_server.conf
        regexp: "^{{ item.param }}="
        line: "{{ item.param }}={{ item.value }}"
      loop:
        - { param: "DBPassword", value: "{{ vault_zabbix_db_password }}" }
        - { param: "DBHost", value: "localhost" }
        - { param: "DBName", value: "zabbix" }
        - { param: "DBUser", value: "zabbix" }
      no_log: true
      notify: restart zabbix-server

    - name: "Start Zabbix server and agent"
      systemd:
        name: "{{ item }}"
        state: started
        enabled: yes
      loop:
        - zabbix-server
        - zabbix-agent

  handlers:
    - name: restart zabbix-server
      systemd:
        name: zabbix-server
        state: restarted
