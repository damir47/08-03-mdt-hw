---
- name: "Zabbix Web Interface"
  hosts: zabbix
  become: yes
  gather_facts: yes
  vars_files:
    - vault/vault.yml

  tasks:
    - name: "Install Apache and PHP"
      apt:
        name:
          - apache2
          - libapache2-mod-php8.3
          - php8.3-pgsql
          - php8.3-mbstring
          - php8.3-gd
          - php8.3-xml
          - php8.3-ldap
          - zabbix-frontend-php
          - php8.3-cli
        state: present

    - name: "Configure PHP timezone"
      lineinfile:
        path: /etc/php/8.3/apache2/php.ini
        regexp: "^;?date.timezone"
        line: "date.timezone = Europe/Moscow"

    - name: "Enable Apache modules"
      command: "a2enmod {{ item }}"
      loop: [rewrite, alias]
      changed_when: false

    - name: "Check if Zabbix Apache config exists"
      stat:
        path: /etc/apache2/conf-available/zabbix.conf
      register: zabbix_conf_file

    - name: "Create Zabbix Apache config if missing"
      copy:
        dest: /etc/apache2/conf-available/zabbix.conf
        content: |
          Alias /zabbix /usr/share/zabbix
          <Directory "/usr/share/zabbix">
              Options FollowSymLinks
              AllowOverride None
              Require all granted
              php_value max_execution_time 300
              php_value memory_limit 128M
              php_value post_max_size 16M
              php_value upload_max_filesize 2M
              php_value max_input_time 300
              php_value max_input_vars 10000
              php_value date.timezone Europe/Moscow
          </Directory>
        owner: root
        group: root
        mode: '0644'
      when: not zabbix_conf_file.stat.exists

    - name: "Enable Zabbix Apache config"
      command: a2enconf zabbix
      args:
        creates: /etc/apache2/conf-enabled/zabbix.conf
      register: enable_result
      failed_when: enable_result.rc != 0 and "already enabled" not in enable_result.stderr

    - name: "Create Zabbix web directory"
      file:
        path: /etc/zabbix/web
        state: directory
        owner: www-data
        group: www-data
        mode: '0755'

    - name: "Create Zabbix web config"
      copy:
        dest: /etc/zabbix/web/zabbix.conf.php
        content: |
          <?php
          global $DB;
          $DB['TYPE']     = 'POSTGRESQL';
          $DB['SERVER']   = 'localhost';
          $DB['PORT']     = '5432';
          $DB['DATABASE'] = 'zabbix';
          $DB['USER']     = 'zabbix';
          $DB['PASSWORD'] = '{{ vault_zabbix_db_password }}';
          $ZBX_SERVER      = 'localhost';
          $ZBX_SERVER_PORT = '10051';
          $ZBX_SERVER_NAME = 'Zabbix Server';
        owner: www-data
        group: www-data
        mode: '0640'
      no_log: true

    - name: "Fix sessions directory"
      file:
        path: /var/lib/php/sessions
        state: directory
        owner: www-data
        group: www-data
        mode: '0733'

    - name: "Generate bcrypt hash for Admin password"
      shell: |
        php -r 'echo password_hash("{{ vault_zabbix_admin_password }}", PASSWORD_BCRYPT);'
      register: admin_hash
      changed_when: false

    - name: "Reset Admin password and unblock account"
      become_user: postgres
      become: yes
      shell: |
        psql -d zabbix -c "UPDATE users SET passwd = '{{ admin_hash.stdout }}', attempt_failed = 0, attempt_clock = 0 WHERE username = 'Admin';"
      register: reset_result
      changed_when: reset_result.rc == 0
      no_log: true

    - name: "Verify password update"
      become_user: postgres
      become: yes
      shell: |
        psql -d zabbix -t -c "SELECT passwd FROM users WHERE username = 'Admin';"
      register: verify
      changed_when: false

    - name: "Debug: show password status"
      debug:
        msg: "Password updated: {{ 'OK' if verify.stdout is defined and verify.stdout | length > 0 else 'FAILED' }}"

    - name: "Restart Apache"
      systemd:
        name: apache2
        state: restarted
        enabled: yes

    - name: "Wait for web interface"
      wait_for:
        port: 80
        host: "{{ ansible_default_ipv4.address }}"
        delay: 5
        timeout: 60

    - name: "Zabbix Web is ready"
      debug:
        msg: |
          ========================================
          ‚úÖ Zabbix Server is ready!
          ========================================
          üåê Web interface: http://{{ ansible_default_ipv4.address }}/zabbix
          üîë Login: Admin
          üîë Password: {{ vault_zabbix_admin_password }}
          ========================================