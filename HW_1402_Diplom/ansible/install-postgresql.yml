- name: "Install PG on vm-yc-zbx01"
  hosts: zabbix
  become: yes
  gather_facts: yes
  vars_files:
    - vault/vault.yml

  tasks:
    - name: "Install PG"
      apt:
        name:
          - postgresql
          - postgresql-contrib
          - acl
        state: present
        update_cache: yes

    - name: "Start PG"
      systemd:
        name: postgresql
        state: started
        enabled: yes

    - name: "Set postgres password"
      become_user: postgres
      become: yes
      shell: |
        psql -c "ALTER USER postgres WITH PASSWORD '{{ vault_postgres_password }}';" || echo "Password may already be set"
      register: result
      changed_when: "'ALTER ROLE' in result.stdout"
      failed_when: false
      no_log: true

    - name: "Get PostgreSQL version"
      shell: "ls /etc/postgresql/"
      register: pg_version
      changed_when: false

    - name: "Show PostgreSQL version"
      debug:
        msg: "PostgreSQL version directory: {{ pg_version.stdout }}"
  
    - name: "Allow local connections with password"
      lineinfile:
        path: "/etc/postgresql/{{ pg_version.stdout }}/main/pg_hba.conf"
        regexp: "^local\\s+all\\s+all"
        line: "local    all             all                                     md5"
        backup: yes
      notify: restart postgresql

    - name: "Allow all interfaces - listen_addresses"
      lineinfile:
        path: "/etc/postgresql/{{ pg_version.stdout }}/main/postgresql.conf"
        regexp: "^#?listen_addresses\\s*="
        line: "listen_addresses = '*'"
        backup: yes
      notify: restart postgresql

    - name: "Allow network 10.0.0.0/8"
      lineinfile:
        path: "/etc/postgresql/{{ pg_version.stdout }}/main/pg_hba.conf"
        line: "host    all             all             10.0.0.0/8          md5"
        insertafter: EOF
        backup: yes
      notify: restart postgresql

    - name: "Restart PostgreSQL to apply changes"
      meta: flush_handlers

    - name: "Verify PostgreSQL is running"
      command: "systemctl is-active postgresql"
      register: pg_status
      changed_when: false
      failed_when: pg_status.stdout != "active"

  handlers:
    - name: restart postgresql
      systemd:
        name: postgresql
        state: restarted