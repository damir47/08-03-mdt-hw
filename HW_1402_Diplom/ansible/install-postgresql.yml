---
- name: "PostgreSQL 16"
  hosts: zabbix
  become: yes
  gather_facts: yes
  vars_files:
    - vault/vault.yml

  tasks:
    - name: "Install dependencies"
      apt:
        name:
          - wget
          - gnupg
          - software-properties-common
          - ca-certificates
        state: present
        update_cache: yes

    - name: "Add PostgreSQL repository key"
      apt_key:
        url: https://www.postgresql.org/media/keys/ACCC4CF8.asc
        state: present

    - name: "Add PostgreSQL 16 repository"
      apt_repository:
        repo: "deb https://apt.postgresql.org/pub/repos/apt {{ ansible_distribution_release }}-pgdg main"
        state: present
        filename: postgresql
        update_cache: yes

    - name: "Install PostgreSQL 16"
      apt:
        name:
          - postgresql-16
          - postgresql-contrib-16
          - acl
          - python3-psycopg2
        state: present

    - name: "Start PostgreSQL"
      systemd:
        name: postgresql
        state: started
        enabled: yes

    - name: "Set postgres password"
      become_user: postgres
      become: yes
      shell: |
        psql -c "ALTER USER postgres WITH PASSWORD '{{ vault_postgres_password }}';"
      register: result
      changed_when: "'ALTER ROLE' in result.stdout"
      no_log: true

    - name: "Configure PostgreSQL for remote access"
      block:
        - name: "Allow local connections with password"
          lineinfile:
            path: "/etc/postgresql/16/main/pg_hba.conf"
            regexp: "^local\\s+all\\s+all"
            line: "local    all             all                                     md5"
            backup: yes

        - name: "Listen on all interfaces"
          lineinfile:
            path: "/etc/postgresql/16/main/postgresql.conf"
            regexp: "^#?listen_addresses\\s*="
            line: "listen_addresses = '*'"
            backup: yes

        - name: "Allow internal network 10.0.0.0/8"
          lineinfile:
            path: "/etc/postgresql/16/main/pg_hba.conf"
            line: "host    all             all             10.0.0.0/8          md5"
            insertafter: EOF
            backup: yes
      notify: restart postgresql

    - name: "Ensure PostgreSQL run directory exists"
      file:
        path: /var/run/postgresql
        state: directory
        owner: postgres
        group: postgres
        mode: '0755'

    - name: "Flush handlers"
      meta: flush_handlers

  handlers:
    - name: restart postgresql
      systemd:
        name: postgresql
        state: restarted
        daemon_reload: yes
